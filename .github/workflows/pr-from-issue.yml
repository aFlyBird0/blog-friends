name: Update Friends From Issue
on:
  issues:
    types: ["opened", "reopened"]

env:
  BLOG_REPO: ${{ secrets.BLOG_REPO }}
  BLOG_LOCAL_PATH: blog
  BLOG_FRIENDS_PATH: content/friends/index.md

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: set up go
        uses: actions/setup-go@v2
        with:
          go-version: 1.19
      - name: Generate Friends Markdown
        run: |
          line=$(cat ${GITHUB_EVENT_PATH} | jq -r '.issue.body' | head -n 1)
          if [ "$line" != "### 站点名字" ] ; then
            exit 0
          fi
          #!/bin/bash

          file_content=$(cat ${GITHUB_EVENT_PATH} | jq -r '.issue.body')
          echo $file_content > input.md
          go mod tidy
          go run . -in input.md -friend ${{ env.BLOG_LOCAL_PATH }}/${{ env.BLOG_FRIENDS_PATH }}

      - name: Checkout Blog Repo
        uses: actions/checkout@v2
        with:
          repository: ${{ env.BLOG_REPO }}
          path: ${{ env.BLOG_LOCAL_PATH }}
          token: ${{ secrets.GH_PAT }}
      - name: Combine Friends Markdown
        run: |
          cat output.md >> blog/content/friends/index.md
      - name: Create Pull Request
        # reference: https://github.com/peter-evans/create-pull-request
        uses: peter-evans/create-pull-request@v4
        with:
          # this GitHub Personal Access Token should have 'repo' scope to the forked repo
          # or any other way in this link:
          # https://github.com/peter-evans/create-pull-request/blob/main/docs/concepts-guidelines.md#workarounds-to-trigger-further-workflow-runs
          token: ${{ secrets.GH_PAT }}
          path: ${{ env.BLOG_LOCAL_PATH }}
          branch: update-friend-links-from-issue
          branch-suffix: timestamp
          title: "feat: update friend links from issue(auto by bot)"
          commit-message: "feat: update friend links from issue(auto by bot)"
          #          body: "Automated changes by [create-pull-request](https://github.com/peter-evans/create-pull-request) GitHub action"
          delete-branch: true
          #          push-to-fork: ${{ env.FORK_REPO }}
          # if you want to active the configuration below,
          # you should use token with admin rights to devlake helm chart repo
          #          reviewers: user1,user2
          #          team-reviewers:
          #          assignees:
          #          labels: bot

          
